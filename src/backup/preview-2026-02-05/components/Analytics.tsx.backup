import { useMemo, useState } from "react";
import type { CompanySettings, Motorcycle, ServiceRecord, VehicleType } from "../types";
import { formatDate, getDaysUntil } from "../utils/helpers";

interface AnalyticsProps {
  motorcycles: Motorcycle[];
  serviceRecords: ServiceRecord[];
  companySettings: CompanySettings;
  onOpenVehicle?: (vehicleId: string) => void;
}

type DocKey = "registration" | "insurance" | "pollution" | "fitness" | "roadTax";

type ServiceDetailMode = "upcoming" | "overdue" | null;

type DocDetailMode = {
  doc: DocKey;
  status: "expiring" | "expired";
} | null;

const DOCS: Array<{ key: DocKey; label: string; appliesTo: "all" | VehicleType }> = [
  { key: "registration", label: "Registration", appliesTo: "private" },
  { key: "insurance", label: "Insurance", appliesTo: "all" },
  { key: "pollution", label: "Pollution", appliesTo: "all" },
  { key: "fitness", label: "Fitness", appliesTo: "commercial" },
  { key: "roadTax", label: "Road Tax", appliesTo: "commercial" },
];

function clampMin0(n: number) {
  return Number.isFinite(n) ? Math.max(0, n) : 0;
}

function safeDateISO(d: Date) {
  return d.toISOString().split("T")[0];
}

function getNextServiceDate(lastServiceDate: string, intervalMonths: number): string {
  const d = new Date(lastServiceDate);
  if (Number.isNaN(d.getTime())) return "";
  const nd = new Date(d);
  nd.setMonth(nd.getMonth() + intervalMonths);
  return safeDateISO(nd);
}

function formatDaysLeft(days: number) {
  if (!Number.isFinite(days)) return "N/A";
  if (days < 0) return `${Math.abs(days)} days overdue`;
  if (days === 0) return "Due today";
  if (days === 1) return "1 day left";
  return `${days} days left`;
}

function formatKmLeft(kmLeft: number) {
  if (!Number.isFinite(kmLeft)) return "N/A";
  if (kmLeft < 0) return `${Math.abs(kmLeft).toLocaleString()} km overdue`;
  if (kmLeft === 0) return "Due now";
  return `${kmLeft.toLocaleString()} km left`;
}

const Analytics = ({ motorcycles, serviceRecords, companySettings, onOpenVehicle }: AnalyticsProps) => {
  const openVehicle = (id: string) => {
    if (onOpenVehicle) onOpenVehicle(id);
  };
  const [serviceDetailMode, setServiceDetailMode] = useState<ServiceDetailMode>(null);
  const [docDetailMode, setDocDetailMode] = useState<DocDetailMode>(null);

  const today = useMemo(() => {
    const d = new Date();
    d.setHours(0, 0, 0, 0);
    return d;
  }, []);

  const safeServiceRecords = Array.isArray(serviceRecords) ? serviceRecords : [];
  const totalVehicles = motorcycles.length;

  const totalServiceCost = safeServiceRecords.reduce((sum, r) => sum + (r.amount || 0), 0);
  const avgServiceCost = safeServiceRecords.length > 0 ? totalServiceCost / safeServiceRecords.length : 0;

  const formatCurrency = (amount: number) => {
    return new Intl.NumberFormat("en-IN", {
      style: "currency",
      currency: "INR",
      maximumFractionDigits: 0,
    }).format(amount);
  };

  const formatNumber = (num: number) => {
    return new Intl.NumberFormat("en-IN").format(Math.round(num));
  };

  const serviceRows = useMemo(() => {
    return motorcycles
      .map((m) => {
        const kmReadings = Array.isArray(m.kmReadings) ? m.kmReadings : [];
        const currentKm = kmReadings.length > 0
          ? Math.max(...kmReadings.map((r) => r.kilometers))
          : (m.currentOdometer ?? m.lastServiceKm ?? 0);

        const intervalMonths = m.serviceIntervalMonths || 5;
        const intervalKms = m.serviceIntervalKms || 5000;

        const lastKm = m.lastServiceKm || 0;
        const kmSince = clampMin0(currentKm - lastKm);
        const kmLeft = intervalKms - kmSince;

        const nextDate = m.lastServiceDate ? getNextServiceDate(m.lastServiceDate, intervalMonths) : "";
        const daysLeft = nextDate ? getDaysUntil(nextDate) : Infinity;

        const overdue = kmLeft <= 0 || daysLeft <= 0;
        const upcoming = !overdue && (kmLeft <= 500 || daysLeft <= 15);
        const status: "ok" | "upcoming" | "overdue" = overdue ? "overdue" : upcoming ? "upcoming" : "ok";

        const urgencyKey = overdue ? 0 : upcoming ? 1 : 2;
        const soonest = Math.min(
          Number.isFinite(daysLeft) ? daysLeft : 999999,
          Number.isFinite(kmLeft) ? Math.max(0, Math.ceil(kmLeft / 50)) : 999999
        );

        return {
          id: m.id,
          name: `${m.make} ${m.model}`,
          registrationNumber: m.registrationNumber,
          status,
          currentKm,
          kmLeft,
          daysLeft,
          nextDate,
          urgencyKey,
          soonest,
        };
      })
      .sort((a, b) => (a.urgencyKey - b.urgencyKey) || (a.soonest - b.soonest) || a.name.localeCompare(b.name));
  }, [motorcycles]);

  const serviceStatusCount = useMemo(() => {
    return serviceRows.reduce(
      (acc, r) => {
        acc[r.status] += 1;
        return acc;
      },
      { ok: 0, upcoming: 0, overdue: 0 }
    );
  }, [serviceRows]);

  const serviceUpcomingList = useMemo(
    () => serviceRows.filter((r) => r.status === "upcoming"),
    [serviceRows]
  );
  const serviceOverdueList = useMemo(
    () => serviceRows.filter((r) => r.status === "overdue"),
    [serviceRows]
  );

  const docRows = useMemo(() => {
    const rows: Array<{
      doc: DocKey;
      vehicleId: string;
      vehicleName: string;
      registrationNumber: string;
      vehicleType: VehicleType;
      validTill: string;
      daysLeft: number;
      status: "valid" | "expiring" | "expired";
    }> = [];

    for (const m of motorcycles) {
      const vType: VehicleType = m.vehicleType || "commercial";
      const name = `${m.make} ${m.model}`;

      const docDateByKey: Record<DocKey, string | undefined> = {
        registration: m.registrationValidity,
        insurance: m.insuranceValidity,
        pollution: m.pollutionValidity,
        fitness: m.fitnessValidity,
        roadTax: m.roadTaxValidity,
      };

      for (const d of DOCS) {
        if (d.appliesTo !== "all" && d.appliesTo !== vType) continue;
        const date = docDateByKey[d.key];
        if (!date) continue;

        const daysLeft = getDaysUntil(date);
        const status = daysLeft <= 0 ? "expired" : daysLeft <= 30 ? "expiring" : "valid";

        rows.push({
          doc: d.key,
          vehicleId: m.id,
          vehicleName: name,
          registrationNumber: m.registrationNumber,
          vehicleType: vType,
          validTill: date,
          daysLeft,
          status,
        });
      }
    }

    const statusOrder: Record<string, number> = { expired: 0, expiring: 1, valid: 2 };
    rows.sort((a, b) => {
      return (
        (statusOrder[a.status] - statusOrder[b.status]) ||
        (a.daysLeft - b.daysLeft) ||
        a.vehicleName.localeCompare(b.vehicleName)
      );
    });

    return rows;
  }, [motorcycles]);

  const documentStats = useMemo(() => {
    const stats: Record<DocKey, { expired: number; expiring: number; valid: number }> = {
      registration: { expired: 0, expiring: 0, valid: 0 },
      insurance: { expired: 0, expiring: 0, valid: 0 },
      pollution: { expired: 0, expiring: 0, valid: 0 },
      fitness: { expired: 0, expiring: 0, valid: 0 },
      roadTax: { expired: 0, expiring: 0, valid: 0 },
    };

    for (const r of docRows) {
      stats[r.doc][r.status] += 1;
    }

    return stats;
  }, [docRows]);

  const getDocDetailList = useMemo(() => {
    if (!docDetailMode) return [];
    return docRows.filter((r) => r.doc === docDetailMode.doc && r.status === docDetailMode.status);
  }, [docDetailMode, docRows]);

  const totalFleetKm = useMemo(() => {
    return motorcycles.reduce((sum, m) => {
      const kmReadings = Array.isArray(m.kmReadings) ? m.kmReadings : [];
      const maxKm = kmReadings.length > 0
        ? Math.max(...kmReadings.map((r) => r.kilometers))
        : (m.currentOdometer ?? m.lastServiceKm ?? 0);
      return sum + maxKm;
    }, 0);
  }, [motorcycles]);

  const uniqueMakes = [...new Set(motorcycles.map((m) => m.make))];
  const uniqueModels = [...new Set(motorcycles.map((m) => `${m.make} ${m.model}`))];

  const validDocTotal =
    documentStats.insurance.valid +
    documentStats.pollution.valid +
    documentStats.fitness.valid +
    documentStats.roadTax.valid +
    documentStats.registration.valid;

  const docCountTotal = docRows.length;
  const docHealth = docCountTotal > 0 ? (validDocTotal / docCountTotal) * 100 : 100;

  const serviceHealth = totalVehicles > 0
    ? ((serviceStatusCount.ok * 100 + serviceStatusCount.upcoming * 50 + serviceStatusCount.overdue * 0) / totalVehicles)
    : 100;

  const healthScore = totalVehicles > 0 ? Math.round(serviceHealth * 0.4 + docHealth * 0.6) : 0;

  const getHealthColor = (score: number) => {
    if (score >= 80) return "text-green-600 bg-green-100";
    if (score >= 60) return "text-yellow-600 bg-yellow-100";
    return "text-red-600 bg-red-100";
  };

  if (totalVehicles === 0) {
    return (
      <div className="p-6">
        <div className="bg-white rounded-xl shadow-md p-12 text-center">
          <div className="text-6xl mb-4">ðŸ“Š</div>
          <h2 className="text-2xl font-bold text-gray-700 mb-2">No Data Yet</h2>
          <p className="text-gray-500">Add some vehicles to see analytics and insights!</p>
        </div>
      </div>
    );
  }

  const renderServiceDetail = (mode: Exclude<ServiceDetailMode, null>) => {
    const list = mode === "upcoming" ? serviceUpcomingList : serviceOverdueList;
    const title = mode === "upcoming" ? "Service Upcoming" : "Service Overdue";

    return (
      <div className="mt-4 rounded-xl border border-gray-200 overflow-hidden">
        <div className="px-4 py-3 bg-gray-50 flex items-center justify-between">
          <div>
            <div className="font-semibold text-gray-900">{title}</div>
            <div className="text-xs text-gray-600">Vehicles: {list.length}</div>
          </div>
          <button
            type="button"
            className="text-sm px-3 py-1.5 rounded-lg bg-gray-900 text-amber-200 hover:bg-black"
            onClick={() => setServiceDetailMode(null)}
          >
            Close
          </button>
        </div>

        <div className="overflow-x-auto">
          <table className="w-full text-sm">
            <thead className="bg-white">
              <tr className="border-b">
                <th className="text-left p-3">Vehicle</th>
                <th className="text-left p-3">Reg.</th>
                <th className="text-right p-3">KM Left</th>
                <th className="text-right p-3">Days Left</th>
                <th className="text-left p-3">Due Date</th>
              </tr>
            </thead>
            <tbody>
              {list.map((r) => (
                <tr
                  key={r.id}
                  className="border-b hover:bg-amber-50 cursor-pointer"
                  onClick={() => openVehicle(r.id)}
                  title="Open vehicle"
                >
                  <td className="p-3 font-medium text-gray-900">{r.name}</td>
                  <td className="p-3 font-mono text-gray-600">{r.registrationNumber}</td>
                  <td className="p-3 text-right">
                    <span className={r.kmLeft <= 0 ? "text-red-700 font-semibold" : r.kmLeft <= 500 ? "text-amber-700 font-semibold" : "text-gray-800"}>
                      {formatKmLeft(r.kmLeft)}
                    </span>
                  </td>
                  <td className="p-3 text-right">
                    <span className={r.daysLeft <= 0 ? "text-red-700 font-semibold" : r.daysLeft <= 15 ? "text-amber-700 font-semibold" : "text-gray-800"}>
                      {formatDaysLeft(r.daysLeft)}
                    </span>
                  </td>
                  <td className="p-3 text-gray-700">{r.nextDate ? formatDate(r.nextDate) : "Not set"}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    );
  };

  const renderDocDetail = (mode: Exclude<DocDetailMode, null>) => {
    const docLabel = DOCS.find((d) => d.key === mode.doc)?.label || mode.doc;
    const list = getDocDetailList;

    return (
      <div className="mt-4 rounded-xl border border-gray-200 overflow-hidden">
        <div className="px-4 py-3 bg-gray-50 flex items-center justify-between">
          <div>
            <div className="font-semibold text-gray-900">
              {docLabel}: {mode.status === "expiring" ? "Expiring Soon" : "Expired"}
            </div>
            <div className="text-xs text-gray-600">Vehicles: {list.length}</div>
          </div>
          <button
            type="button"
            className="text-sm px-3 py-1.5 rounded-lg bg-gray-900 text-amber-200 hover:bg-black"
            onClick={() => setDocDetailMode(null)}
          >
            Close
          </button>
        </div>

        <div className="overflow-x-auto">
          <table className="w-full text-sm">
            <thead className="bg-white">
              <tr className="border-b">
                <th className="text-left p-3">Vehicle</th>
                <th className="text-left p-3">Reg.</th>
                <th className="text-left p-3">Valid Till</th>
                <th className="text-right p-3">Time Left</th>
              </tr>
            </thead>
            <tbody>
              {list.map((r) => (
                <tr
                  key={`${r.vehicleId}-${r.doc}`}
                  className="border-b hover:bg-amber-50 cursor-pointer"
                  onClick={() => openVehicle(r.vehicleId)}
                  title="Open vehicle"
                >
                  <td className="p-3 font-medium text-gray-900">{r.vehicleName}</td>
                  <td className="p-3 font-mono text-gray-600">{r.registrationNumber}</td>
                  <td className="p-3 text-gray-700">{formatDate(r.validTill)}</td>
                  <td className="p-3 text-right">
                    <span className={r.daysLeft <= 0 ? "text-red-700 font-semibold" : "text-amber-700 font-semibold"}>
                      {formatDaysLeft(r.daysLeft)}
                    </span>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    );
  };

  return (
    <div className="p-4 md:p-6 space-y-6">
      {companySettings.companyName && (
        <div className="bg-white rounded-xl shadow-md p-6 flex items-center gap-4">
          {companySettings.logo && (
            <img
              src={companySettings.logo}
              alt="Logo"
              className="h-16 w-16 object-contain rounded-lg"
            />
          )}
          <div>
            <h1
              className="text-2xl font-bold"
              style={{ color: companySettings.primaryColor || "#1e40af" }}
            >
              {companySettings.companyName}
            </h1>
            {companySettings.tagline && (
              <p className="text-gray-500">{companySettings.tagline}</p>
            )}
          </div>
          <div className="ml-auto text-right text-sm text-gray-500">
            <p>ðŸ“§ {companySettings.email || "-"}</p>
            <p>ðŸ“ž {companySettings.phone || "-"}</p>
          </div>
        </div>
      )}

      <div className="bg-white rounded-xl shadow-md p-6">
        <div className="flex items-center justify-between">
          <div>
            <h2 className="text-xl font-bold text-gray-800 mb-1">Fleet Health Score</h2>
            <p className="text-gray-500 text-sm">Based on service status and document validity</p>
          </div>
          <div className={`text-5xl font-bold rounded-full w-24 h-24 flex items-center justify-center ${getHealthColor(healthScore)}`}>{healthScore}</div>
        </div>
        <div className="mt-4 bg-gray-200 rounded-full h-4 overflow-hidden">
          <div className={`${healthScore >= 80 ? "bg-green-500" : healthScore >= 60 ? "bg-yellow-500" : "bg-red-500"} h-full transition-all duration-500`} style={{ width: `${healthScore}%` }} />
        </div>
      </div>

      <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
        <div className="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-4 text-white">
          <div className="text-3xl font-bold">{totalVehicles}</div>
          <div className="text-blue-100 text-sm">Total Vehicles</div>
        </div>
        <div className="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-4 text-white">
          <div className="text-3xl font-bold">{uniqueMakes.length}</div>
          <div className="text-purple-100 text-sm">Brands</div>
        </div>
        <div className="bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-xl p-4 text-white">
          <div className="text-3xl font-bold">{uniqueModels.length}</div>
          <div className="text-indigo-100 text-sm">Models</div>
        </div>
        <div className="bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-4 text-white">
          <div className="text-3xl font-bold">{safeServiceRecords.length}</div>
          <div className="text-green-100 text-sm">Total Services</div>
        </div>
        <div className="bg-gradient-to-br from-amber-500 to-amber-600 rounded-xl p-4 text-white">
          <div className="text-2xl font-bold">{formatNumber(totalFleetKm)}</div>
          <div className="text-amber-100 text-sm">Total Fleet KM</div>
        </div>
        <div className="bg-gradient-to-br from-rose-500 to-rose-600 rounded-xl p-4 text-white">
          <div className="text-2xl font-bold">{formatCurrency(totalServiceCost)}</div>
          <div className="text-rose-100 text-sm">Total Spent</div>
        </div>
      </div>

      <div className="grid md:grid-cols-2 gap-6">
        <div className="bg-white rounded-xl shadow-md p-6">
          <div className="flex items-center justify-between gap-3 mb-4">
            <h3 className="text-lg font-bold text-gray-800">ðŸ”§ Service Status</h3>
            <div className="text-xs text-gray-500">Based on 5,000km/5 months thresholds (or configured per vehicle)</div>
          </div>
          <div className="space-y-3">
            <div className="flex items-center justify-between">
              <span className="flex items-center gap-2"><span className="w-3 h-3 rounded-full bg-green-500" />Service OK</span>
              <span className="font-bold text-green-600">{serviceStatusCount.ok} vehicles</span>
            </div>
            <div className="flex items-center justify-between">
              <span className="flex items-center gap-2"><span className="w-3 h-3 rounded-full bg-amber-500" />Service Upcoming</span>
              <div className="flex items-center gap-2">
                <span className="font-bold text-amber-600">{serviceStatusCount.upcoming}</span>
                {serviceStatusCount.upcoming > 0 && (
                  <button type="button" onClick={() => setServiceDetailMode("upcoming")} className="text-xs px-2 py-1 rounded-md bg-amber-50 border border-amber-200 text-amber-900 hover:bg-amber-100">View</button>
                )}
              </div>
            </div>
            <div className="flex items-center justify-between">
              <span className="flex items-center gap-2"><span className="w-3 h-3 rounded-full bg-red-500" />Service Overdue</span>
              <div className="flex items-center gap-2">
                <span className="font-bold text-red-600">{serviceStatusCount.overdue}</span>
                {serviceStatusCount.overdue > 0 && (
                  <button type="button" onClick={() => setServiceDetailMode("overdue")} className="text-xs px-2 py-1 rounded-md bg-red-50 border border-red-200 text-red-800 hover:bg-red-100">View</button>
                )}
              </div>
            </div>
          </div>

          <div className="mt-4 flex rounded-full overflow-hidden h-6">
            {serviceStatusCount.ok > 0 && (
              <div className="bg-green-500 flex items-center justify-center text-white text-xs font-bold" style={{ width: `${(serviceStatusCount.ok / totalVehicles) * 100}%` }}>{serviceStatusCount.ok}</div>
            )}
            {serviceStatusCount.upcoming > 0 && (
              <div className="bg-amber-500 flex items-center justify-center text-white text-xs font-bold" style={{ width: `${(serviceStatusCount.upcoming / totalVehicles) * 100}%` }}>{serviceStatusCount.upcoming}</div>
            )}
            {serviceStatusCount.overdue > 0 && (
              <div className="bg-red-500 flex items-center justify-center text-white text-xs font-bold" style={{ width: `${(serviceStatusCount.overdue / totalVehicles) * 100}%` }}>{serviceStatusCount.overdue}</div>
            )}
          </div>

          {serviceDetailMode && (
            <div className="mt-4 rounded-xl border border-gray-200 overflow-hidden">
              <div className="px-4 py-3 bg-gray-50 flex items-center justify-between">
                <div>
                  <div className="font-semibold text-gray-900">{serviceDetailMode === "upcoming" ? "Service Upcoming" : "Service Overdue"}</div>
                  <div className="text-xs text-gray-600">Vehicles: {(serviceDetailMode === "upcoming" ? serviceUpcomingList : serviceOverdueList).length}</div>
                </div>
                <button type="button" className="text-sm px-3 py-1.5 rounded-lg bg-gray-900 text-amber-200 hover:bg-black" onClick={() => setServiceDetailMode(null)}>Close</button>
              </div>
              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead className="bg-white">
                    <tr className="border-b">
                      <th className="text-left p-3">Vehicle</th>
                      <th className="text-left p-3">Reg.</th>
                      <th className="text-right p-3">KM Left</th>
                      <th className="text-right p-3">Days Left</th>
                      <th className="text-left p-3">Due Date</th>
                    </tr>
                  </thead>
                  <tbody>
                    {(serviceDetailMode === "upcoming" ? serviceUpcomingList : serviceOverdueList).map((r) => (
                      <tr key={r.id} className="border-b hover:bg-amber-50 cursor-pointer" onClick={() => openVehicle(r.id)} title="Open vehicle">
                        <td className="p-3 font-medium text-gray-900">{r.name}</td>
                        <td className="p-3 font-mono text-gray-600">{r.registrationNumber}</td>
                        <td className="p-3 text-right"><span className={r.kmLeft <= 0 ? "text-red-700 font-semibold" : r.kmLeft <= 500 ? "text-amber-700 font-semibold" : "text-gray-800"}>{formatKmLeft(r.kmLeft)}</span></td>
                        <td className="p-3 text-right"><span className={r.daysLeft <= 0 ? "text-red-700 font-semibold" : r.daysLeft <= 15 ? "text-amber-700 font-semibold" : "text-gray-800"}>{formatDaysLeft(r.daysLeft)}</span></td>
                        <td className="p-3 text-gray-700">{r.nextDate ? formatDate(r.nextDate) : "Not set"}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}
        </div>

        <div className="bg-white rounded-xl shadow-md p-6">
          <div className="flex items-center justify-between gap-3 mb-4">
            <h3 className="text-lg font-bold text-gray-800">ðŸ“„ Document Status</h3>
            <div className="text-xs text-gray-500">Expiring = within 30 days</div>
          </div>

          <div className="space-y-3">
            {DOCS.map(({ key, label }) => {
              const stats = documentStats[key];
              const canShow = (stats.expired + stats.expiring + stats.valid) > 0;
              if (!canShow) return null;

              return (
                <div key={key} className="space-y-1">
                  <div className="flex justify-between text-sm items-center gap-2">
                    <span className="font-medium">{label}</span>
                    <span className="text-gray-500 flex items-center gap-2">
                      <span className="text-green-600">{stats.valid}âœ“</span>
                      <span className="text-amber-600">{stats.expiring}âš </span>
                      <span className="text-red-600">{stats.expired}âœ—</span>

                      {stats.expiring > 0 && (
                        <button type="button" onClick={() => setDocDetailMode({ doc: key, status: "expiring" })} className="ml-1 text-[11px] px-2 py-1 rounded-md bg-amber-50 border border-amber-200 text-amber-900 hover:bg-amber-100">View expiring</button>
                      )}
                      {stats.expired > 0 && (
                        <button type="button" onClick={() => setDocDetailMode({ doc: key, status: "expired" })} className="text-[11px] px-2 py-1 rounded-md bg-red-50 border border-red-200 text-red-800 hover:bg-red-100">View expired</button>
                      )}
                    </span>
                  </div>

                  <div className="flex rounded-full overflow-hidden h-2 bg-gray-200">
                    {stats.valid > 0 && (
                      <div className="bg-green-500" style={{ width: `${(stats.valid / totalVehicles) * 100}%` }} />
                    )}
                    {stats.expiring > 0 && (
                      <div className="bg-amber-500" style={{ width: `${(stats.expiring / totalVehicles) * 100}%` }} />
                    )}
                    {stats.expired > 0 && (
                      <div className="bg-red-500" style={{ width: `${(stats.expired / totalVehicles) * 100}%` }} />
                    )}
                  </div>
                </div>
              );
            })}
          </div>

          {docDetailMode && (
            <div className="mt-4 rounded-xl border border-gray-200 overflow-hidden">
              <div className="px-4 py-3 bg-gray-50 flex items-center justify-between">
                <div>
                  <div className="font-semibold text-gray-900">{DOCS.find((d) => d.key === docDetailMode.doc)?.label}: {docDetailMode.status === "expiring" ? "Expiring Soon" : "Expired"}</div>
                  <div className="text-xs text-gray-600">Vehicles: {getDocDetailList.length}</div>
                </div>
                <button type="button" className="text-sm px-3 py-1.5 rounded-lg bg-gray-900 text-amber-200 hover:bg-black" onClick={() => setDocDetailMode(null)}>Close</button>
              </div>
              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead className="bg-white">
                    <tr className="border-b">
                      <th className="text-left p-3">Vehicle</th>
                      <th className="text-left p-3">Reg.</th>
                      <th className="text-left p-3">Valid Till</th>
                      <th className="text-right p-3">Time Left</th>
                    </tr>
                  </thead>
                  <tbody>
                    {getDocDetailList.map((r) => (
                      <tr key={`${r.vehicleId}-${r.doc}`} className="border-b hover:bg-amber-50 cursor-pointer" onClick={() => openVehicle(r.vehicleId)} title="Open vehicle">
                        <td className="p-3 font-medium text-gray-900">{r.vehicleName}</td>
                        <td className="p-3 font-mono text-gray-600">{r.registrationNumber}</td>
                        <td className="p-3 text-gray-700">{formatDate(r.validTill)}</td>
                        <td className="p-3 text-right"><span className={r.daysLeft <= 0 ? "text-red-700 font-semibold" : "text-amber-700 font-semibold"}>{formatDaysLeft(r.daysLeft)}</span></td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}
        </div>
      </div>

      <div className="bg-gradient-to-r from-gray-800 to-gray-900 rounded-xl shadow-md p-6 text-white">
        <h3 className="text-lg font-bold mb-4">ðŸ“Š Fleet Averages</h3>
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div className="text-center">
            <div className="text-3xl font-bold text-blue-400">{formatNumber(totalFleetKm / Math.max(1, totalVehicles))}</div>
            <div className="text-gray-400 text-sm">Avg KM per Vehicle</div>
          </div>
          <div className="text-center">
            <div className="text-3xl font-bold text-green-400">{formatCurrency(avgServiceCost)}</div>
            <div className="text-gray-400 text-sm">Avg Service Cost</div>
          </div>
          <div className="text-center">
            <div className="text-3xl font-bold text-purple-400">{totalVehicles > 0 ? (safeServiceRecords.length / totalVehicles).toFixed(1) : 0}</div>
            <div className="text-gray-400 text-sm">Avg Services/Vehicle</div>
          </div>
          <div className="text-center">
            <div className="text-3xl font-bold text-amber-400">{formatCurrency(totalVehicles > 0 ? totalServiceCost / totalVehicles : 0)}</div>
            <div className="text-gray-400 text-sm">Avg Spent/Vehicle</div>
          </div>
        </div>
      </div>

      <div className="text-xs text-gray-500">Updated: {formatDate(safeDateISO(today))}</div>
    </div>
  );
};

export default Analytics;
